<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Frontend Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #status { 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0;
            font-weight: bold;
        }
        .connected { background: #4CAF50; color: white; }
        .connecting { background: #FFC107; }
        .disconnected { background: #f44336; color: white; }
        .error { background: #9C27B0; color: white; }
        #messages { 
            border: 1px solid #ccc; 
            padding: 10px; 
            height: 300px; 
            overflow-y: auto;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
        }
        button { margin: 5px; padding: 10px 20px; cursor: pointer; }
        input { width: 100%; padding: 8px; margin: 10px 0; }
        .message-entry { padding: 2px 0; border-bottom: 1px dotted #ccc; }
        .time { color: #666; }
        .success { color: green; }
        .error-msg { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>WebSocket Frontend Test - XM-Port</h1>
    
    <input type="text" id="token" placeholder="Paste your access token here">
    
    <div id="status" class="disconnected">Disconnected</div>
    
    <div>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="sendPing()">Send Ping</button>
        <button onclick="clearMessages()">Clear Messages</button>
        <button onclick="getNewToken()">Get New Token</button>
    </div>
    
    <div id="messages"></div>

    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function log(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const time = new Date().toISOString().split('T')[1].split('.')[0];
            const cssClass = type === 'error' ? 'error-msg' : type === 'success' ? 'success' : 'info';
            messagesDiv.innerHTML = 
                `<div class="message-entry">` +
                `<span class="time">[${time}]</span> ` +
                `<span class="${cssClass}">${message}</span>` +
                `</div>` + messagesDiv.innerHTML;
        }

        function updateStatus(status, className) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = status;
            statusDiv.className = className;
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            log('Messages cleared', 'info');
        }

        function getNewToken() {
            log('To get a new token, run: python3 create_test_user.py', 'info');
        }

        function connect() {
            const token = document.getElementById('token').value.trim();
            
            if (!token) {
                log('‚ùå Please enter a token first', 'error');
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                log('‚ö†Ô∏è Already connected', 'info');
                return;
            }

            if (ws && ws.readyState === WebSocket.CONNECTING) {
                log('‚ö†Ô∏è Connection already in progress', 'info');
                return;
            }

            const wsUrl = `ws://localhost:8000/api/v1/ws/processing-updates?token=${encodeURIComponent(token)}`;
            log(`üîå Connecting to WebSocket...`, 'info');
            updateStatus('Connecting...', 'connecting');
            
            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    log('‚úÖ WebSocket connected successfully!', 'success');
                    updateStatus('Connected', 'connected');
                    reconnectAttempts = 0;
                    
                    // Send initial ping
                    setTimeout(() => sendPing(), 100);
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üì® Received: ${JSON.stringify(data)}`, 'success');
                        
                        // Handle different message types
                        if (data.type === 'processing_update') {
                            log(`üìä Processing Update - Job: ${data.job_id}, Status: ${data.status}, Progress: ${data.progress}%`, 'info');
                        }
                    } catch (e) {
                        log(`üì® Received (raw): ${event.data}`, 'info');
                    }
                };

                ws.onerror = (error) => {
                    log(`‚ùå WebSocket error occurred`, 'error');
                    console.error('WebSocket error:', error);
                };

                ws.onclose = (event) => {
                    ws = null;
                    const reason = event.reason || 'No reason provided';
                    log(`üîå Disconnected - Code: ${event.code}, Reason: ${reason}`, 
                        event.code === 1000 ? 'info' : 'error');
                    
                    if (event.code === 4001) {
                        updateStatus('Authentication Failed', 'error');
                        log('‚ö†Ô∏è Token may be invalid or expired. Get a new token.', 'error');
                    } else if (event.code === 1006) {
                        updateStatus('Connection Lost', 'error');
                        // Attempt reconnection for unexpected disconnects
                        if (reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            log(`üîÑ Reconnecting in 2 seconds... (Attempt ${reconnectAttempts}/${maxReconnectAttempts})`, 'info');
                            setTimeout(() => connect(), 2000);
                        }
                    } else {
                        updateStatus('Disconnected', 'disconnected');
                    }
                };
            } catch (error) {
                log(`‚ùå Failed to create WebSocket: ${error.message}`, 'error');
                updateStatus('Error', 'error');
            }
        }

        function disconnect() {
            reconnectAttempts = maxReconnectAttempts; // Prevent auto-reconnect
            if (ws) {
                log('üëã Closing connection...', 'info');
                ws.close(1000, 'Manual disconnect');
            } else {
                log('‚ö†Ô∏è Not connected', 'info');
            }
        }

        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = { type: 'ping', timestamp: Date.now() };
                ws.send(JSON.stringify(message));
                log(`üì§ Sent: ${JSON.stringify(message)}`, 'info');
            } else {
                log('‚ö†Ô∏è WebSocket not connected', 'error');
            }
        }

        // Initialize with instructions
        window.onload = () => {
            log('üëã Welcome to WebSocket Test!', 'success');
            log('1. Run "python3 create_test_user.py" to get a token', 'info');
            log('2. Paste the token in the input field above', 'info');
            log('3. Click "Connect" to establish WebSocket connection', 'info');
        };
    </script>
</body>
</html>