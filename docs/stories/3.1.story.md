# Story 3.1: User Dashboard

## Status
Approved

## Story
**As a** customs broker,
**I want** access a comprehensive dashboard that displays my file processing history, credit balance, job statuses, and enables me to download processed XML files,
**so that** I can efficiently track all my processing activities, monitor my account status, and quickly access my completed customs declaration files in one centralized location.

## Acceptance Criteria
1. Display file processing history with job details (file name, date, status, processing time)
2. Show current credit balance and monthly usage statistics
3. Enable download of processed XML files with secure links
4. Provide real-time processing status tracking for active jobs
5. Display uploaded data preview for each processing job
6. Implement pagination for processing history (50 jobs per page)
7. Add search and filter capabilities by date range, status, or file name
8. Show processing statistics (total jobs, success rate, average confidence)
9. Provide user profile management with company and country settings
10. Implement responsive design for mobile and desktop access

## Tasks / Subtasks

- [ ] Task 1: Dashboard Layout and Navigation (AC: 10)
  - [ ] Create dashboard layout component with responsive sidebar navigation
  - [ ] Implement header with user profile and credit balance display
  - [ ] Add mobile-responsive navigation menu
  - [ ] Set up dashboard routing and page structure

- [ ] Task 2: Processing History Display (AC: 1, 6, 7)
  - [ ] Create JobHistory component with table view of processing jobs
  - [ ] Implement pagination (50 jobs per page)
  - [ ] Add search functionality by file name
  - [ ] Add date range and status filter controls
  - [ ] Display job details: file name, date, status, processing time

- [ ] Task 3: Credit Balance and Usage Statistics (AC: 2, 8)
  - [ ] Create CreditBalance component showing current credits
  - [ ] Display monthly usage tracking and statistics
  - [ ] Show processing statistics (total jobs, success rate, average confidence)
  - [ ] Add usage analytics visualization with charts

- [ ] Task 4: File Download Functionality (AC: 3)
  - [ ] Implement secure XML file download with pre-signed S3 URLs
  - [ ] Add download buttons for completed jobs
  - [ ] Handle download errors and expired links
  - [ ] Track download activity for analytics

- [ ] Task 5: Real-time Status Tracking (AC: 4)
  - [ ] Integrate WebSocket connection for live job updates
  - [ ] Update job status in real-time without page refresh
  - [ ] Show progress bars for active processing jobs
  - [ ] Display processing notifications and alerts

- [ ] Task 6: Data Preview and Job Details (AC: 5)
  - [ ] Create JobDetails modal/page showing uploaded data
  - [ ] Display product matches and HS code results
  - [ ] Show confidence scores and validation status
  - [ ] Provide editable data preview functionality

- [ ] Task 7: User Profile Management (AC: 9)
  - [ ] Create user profile settings page
  - [ ] Allow editing of company name and country settings
  - [ ] Implement profile update functionality
  - [ ] Add password change and account management

- [ ] Task 8: Unit and Integration Testing (All ACs)
  - [ ] Create comprehensive unit tests for all dashboard components
  - [ ] Test WebSocket integration and real-time updates
  - [ ] Test download functionality and error handling
  - [ ] Create E2E tests for complete dashboard workflows

## Dev Notes

### Previous Story Insights
From Story 2.3 completion:
- Complete file processing workflow established from upload to XML generation
- WebSocket progress tracking infrastructure available for real-time updates
- ProcessingJob model tracks comprehensive processing status and statistics
- S3 integration working with secure pre-signed download URLs
- JWT authentication system established with user sessions
- Credit management system integrated in processing workflow

### Data Models
[Source: architecture/data-models.md#User]

**User Model Requirements:**
- `creditsRemaining: number` - Available processing credits for dashboard display
- `creditsUsedThisMonth: number` - Monthly usage tracking for statistics
- `company: string` - Brokerage firm name for profile management
- `country: string` - Operating country for schema selection display
- `subscriptionTier: enum` - Subscription level affecting dashboard features
- `lastLoginAt: DateTime` - Activity tracking for session management

[Source: architecture/data-models.md#ProcessingJob]

**ProcessingJob Model Integration:**
- `status: enum` - Current processing state for real-time status display
- `inputFileName: string` - Original file name for history display
- `outputXmlUrl: string | null` - Generated XML location for download functionality
- `creditsUsed: number` - Processing cost for usage statistics
- `processingTimeMs: number` - Performance tracking for job details
- `totalProducts: number` - Products processed for statistics display
- `successfulMatches: number` - Successful matches for success rate calculation
- `averageConfidence: number` - AI matching confidence for quality metrics
- `createdAt: DateTime` - Job submission timestamp for history sorting
- `completedAt: DateTime` - Processing completion for duration calculation

### Frontend Component Specifications
[Source: architecture/frontend-architecture.md#Component-Architecture]

**Dashboard Components Structure:**
- `/apps/web/src/components/dashboard/` - Dashboard-specific components
- `JobHistory.tsx` - Processing job history table with filtering and pagination
- `JobDetails.tsx` - Individual job details modal/page
- `CreditBalance.tsx` - Credit balance display and usage statistics
- `UsageMetrics.tsx` - User usage analytics and visualizations
- Dashboard layout follows `/apps/web/src/app/(dashboard)/dashboard/` route structure

**State Management Integration:**
- Zustand for auth state and user profile management
- React Query for server state (processing jobs, user data, statistics)
- WebSocket integration for real-time processing updates
- NextAuth.js session management for authentication state

### API Specifications
[Source: architecture/api-specification.md#REST-API-Specification]

**Required Dashboard API Endpoints:**
- `GET /api/v1/processing/jobs?page=1&limit=50&search=&status=&dateFrom=&dateTo=` - Processing history with pagination and filters
- `GET /api/v1/users/profile` - User profile data and settings
- `PUT /api/v1/users/profile` - Update user profile information
- `GET /api/v1/users/statistics` - User processing statistics and usage data
- `GET /api/v1/processing/{job_id}/xml-download` - Secure XML file download (already implemented)
- WebSocket `/ws/processing` - Real-time job status updates (already implemented)

### File Locations
[Source: architecture/source-tree.md#Unified-Project-Structure]

**Frontend Dashboard Files:**
- `/apps/web/src/app/(dashboard)/dashboard/page.tsx` - Main dashboard page
- `/apps/web/src/app/(dashboard)/history/page.tsx` - Processing history page
- `/apps/web/src/app/(dashboard)/profile/page.tsx` - User profile management page
- `/apps/web/src/components/dashboard/JobHistory.tsx` - Job history table component
- `/apps/web/src/components/dashboard/JobDetails.tsx` - Job details modal component
- `/apps/web/src/components/dashboard/CreditBalance.tsx` - Credit display component
- `/apps/web/src/components/dashboard/UsageMetrics.tsx` - Usage analytics component
- `/apps/web/src/hooks/useProcessingJobs.ts` - Custom hook for job data fetching
- `/apps/web/src/hooks/useProcessingUpdates.ts` - WebSocket real-time updates hook

**Backend API Files:**
- `/apps/api/src/api/v1/processing.py` - Processing jobs API (extend existing)
- `/apps/api/src/api/v1/users.py` - User profile and statistics API (new)
- `/apps/api/src/services/user_analytics.py` - User analytics service (new)

**Shared Types:**
- `/packages/shared/src/types/user.ts` - User interface with dashboard-specific fields
- `/packages/shared/src/types/processing.ts` - Processing job interfaces (extend existing)
- `/packages/shared/src/types/dashboard.ts` - Dashboard-specific type definitions (new)

### Technical Constraints
[Source: architecture/tech-stack.md#Frontend-Framework]

**Version Requirements:**
- Next.js 15+ with App Router for dashboard page routing
- TypeScript 5.3+ for type-safe development
- shadcn/ui components for consistent dashboard UI
- Zustand 4.4+ for client state management
- React Query 5.0+ for server state and caching
- Tailwind CSS 3.3+ for responsive dashboard design

**Integration Requirements:**
- NextAuth.js integration for dashboard authentication
- WebSocket connection management for real-time updates
- React Query integration with FastAPI backend
- Responsive design supporting mobile and desktop
- Chart.js or similar for usage statistics visualization

### Testing Requirements
[Source: architecture/testing-strategy.md#Frontend-Tests]

**Testing Framework:** Jest + React Testing Library for unit tests, Playwright for E2E testing

**Unit Tests Location:** `/apps/web/tests/components/dashboard/`
- Test JobHistory component rendering and filtering functionality
- Test CreditBalance component with different user subscription tiers  
- Test JobDetails modal with various job statuses and data states
- Test WebSocket integration hooks with mock connections
- Test user profile management form validation and submission

**Integration Tests Location:** `/apps/web/tests/`
- Test complete dashboard workflow from login to job management
- Test real-time WebSocket updates integration  
- Test file download functionality with S3 pre-signed URLs
- Test dashboard navigation and responsive design
- Test authentication and role-based dashboard access

**E2E Tests Location:** `/apps/web/tests/e2e/`
- Test end-to-end dashboard user journey
- Test processing job lifecycle in dashboard view
- Test credit management and usage tracking
- Test file upload to dashboard completion workflow

**Testing Standards:**
- Minimum 90% code coverage for dashboard components
- Test responsive design across mobile and desktop breakpoints
- Test real-time WebSocket updates with mock connections  
- Test authentication and role-based access controls
- Include accessibility testing for dashboard components
- Test job history pagination and filtering with large datasets
- Test credit balance updates and usage statistics accuracy
- Test file download functionality with various file states
- Test WebSocket connection handling and reconnection logic
- Test user profile management form validation and error handling

### Security Requirements
[Source: architecture/security-and-performance.md#Security-Requirements]

**Authentication & Authorization:**
- JWT token validation for all dashboard API endpoints
- User-specific data access control (users can only see their own jobs/data)
- Session timeout and token refresh handling
- Role-based access control for different dashboard features

**Data Protection:**
- No sensitive information (passwords, tokens) stored in frontend state
- Secure handling of processing job data and statistics
- Input sanitization for search filters and form data
- XSS prevention in dynamic content display

**File Security:**
- Pre-signed S3 URL expiration validation before download
- File download authorization (user must own the processing job)
- Secure file handling with proper error messages for expired/missing files
- No direct S3 access from frontend - all downloads via backend API

**Network Security:**
- HTTPS-only communication for all API calls
- WebSocket connection authentication with JWT tokens
- Rate limiting awareness for API calls (respect backend limits)
- Proper error handling without exposing internal system details

### Project Structure Notes
All dashboard files align with Next.js App Router structure in `/apps/web/src/app/(dashboard)/` directory.
Dashboard components follow existing component architecture patterns with shared UI components from shadcn/ui.
WebSocket integration leverages existing `/ws/processing-updates` endpoint established in Story 2.3.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-23 | 1.0 | Initial story creation for User Dashboard | Bob (Scrum Master) |

## Dev Agent Record

**Agent Model Used:** [To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results

[To be filled by QA Agent]