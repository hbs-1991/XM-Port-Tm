# Story 2.2: OpenAI Vector Store Integration for HS Code Matching

## Status
Approved

## Story
**As a** customs broker,
**I want** the system to use OpenAI Vector Store with FileSearchTool for intelligent HS code matching,
**so that** my uploaded products can be accurately matched to the correct HS codes using AI-powered semantic search.

## Acceptance Criteria
1. Integrate OpenAI Agents SDK with FileSearchTool for HS code matching
2. Configure FileSearchTool to access OpenAI Vector Store containing HS codes
3. Implement AI-powered semantic search for product-to-HS code matching
4. Support multiple confidence scoring levels and alternative suggestions
5. Create service layer for HS code matching with error handling and retry logic
6. Implement caching layer for frequently requested HS code matches using Redis
7. Create API endpoints for HS code search and retrieval
8. Support batch processing for multiple products in a single request
9. Track HS code matching statistics for analytics and optimization
10. Achieve sub-2-second response times for HS code matching requests

## Tasks / Subtasks

- [x] Task 1: Set up OpenAI Agents SDK with structured output configuration (AC: 1, 2)
  - [x] Configure OpenAI API credentials and access in environment variables
  - [x] Set up vector store IDs for country-specific HS code collections (e.g., "vs_hs_codes_turkmenistan")
  - [x] Create Pydantic models for structured HS code matching output using `output_type`
  - [x] Configure Agent with FileSearchTool and structured output format
  - [x] Test connection to OpenAI Vector Store with sample HS code queries
  - [x] Document vector store setup and management procedures

- [ ] Task 2: Implement HS code matching service (AC: 1, 3, 4)
  - [ ] Create HSCodeMatchingService in `/apps/api/src/services/hs_matching_service.py`
  - [ ] Implement Agent with FileSearchTool configuration
  - [ ] Add product description to HS code matching logic
  - [ ] Implement confidence scoring and alternative suggestions
  - [ ] Add retry logic and error handling for OpenAI API failures

- [ ] Task 3: Create service layer with caching (AC: 5, 6)
  - [ ] Implement caching service in `/apps/api/src/services/cache_service.py`
  - [ ] Add Redis caching for frequently matched HS codes
  - [ ] Implement cache warming strategies for common product descriptions
  - [ ] Add cache invalidation and TTL management
  - [ ] Create fallback mechanisms when cache is unavailable

- [ ] Task 4: Build API endpoints (AC: 7, 8)
  - [ ] Create HS code endpoints in `/apps/api/src/api/v1/hs_matching.py`
  - [ ] `POST /api/v1/hs-codes/match` - Single product matching
  - [ ] `POST /api/v1/hs-codes/batch-match` - Batch product matching
  - [ ] `GET /api/v1/hs-codes/search` - Search HS codes with query
  - [ ] Add proper authentication and rate limiting
  - [ ] Implement request/response validation with Pydantic schemas

- [ ] Task 5: Implement analytics and monitoring (AC: 9)
  - [ ] Create analytics service for tracking HS code matching usage
  - [ ] Implement matching statistics collection
  - [ ] Add performance monitoring and logging
  - [ ] Create dashboard endpoints for match analytics
  - [ ] Track confidence score distributions and accuracy metrics

- [ ] Task 6: Performance optimization (AC: 10)
  - [ ] Implement async processing for batch requests
  - [ ] Add connection pooling for OpenAI API calls
  - [ ] Optimize FileSearchTool parameters for performance
  - [ ] Implement request queuing and throttling
  - [ ] Add performance benchmarking and monitoring

- [ ] Task 7: Integration with existing processing workflow (All ACs)
  - [ ] Update FileProcessingService to use new HS matching service
  - [ ] Integrate HS code matching into product processing pipeline
  - [ ] Update ProductMatch model to store Vector Store results
  - [ ] Add error handling for HS code matching failures
  - [ ] Test complete workflow from file upload to HS code matching

- [ ] Task 8: Comprehensive testing (All ACs)
  - [ ] Unit tests for HS matching service and API endpoints
  - [ ] Integration tests with OpenAI Vector Store
  - [ ] Performance tests for batch processing and response times
  - [ ] End-to-end tests for complete matching workflow
  - [ ] Load tests for concurrent matching requests

## Dev Notes

### OpenAI Agents SDK Configuration
[Source: architecture/external-apis.md#OpenAI-Agents-SDK-API]

**FileSearchTool Setup:**
```python
from agents import Agent, FileSearchTool, Runner
from pydantic import Basemodel

class CodeResult(Basemodel)
      hs_code: str,
      code_description: str,
      confidence = float,


# Configure agent with FileSearchTool
agent = Agent(
    name="HS Code Matcher",
    instructions="You are an expert in HS code classification. Match product descriptions to the most appropriate HS codes with confidence scores.",
    tools=[
        FileSearchTool(
            max_num_results=5,
            vector_store_ids=["vs_hs_codes_turkmenistan"],
        ),
    ],
    output_type= CodeResult
)

# Execute matching
async def match_hs_code(product_description: str) -> HSCodeMatch:
    result = await Runner.run(
        agent,
        f"Find the most appropriate HS code for: {product_description}",
    )
    return parse_hs_code_result(result.final_output)
```

### Previous Story Integration
[Source: Story 2.1 - File Upload/Validation]
- File processing pipeline is established with ProductMatch model
- Product data validation is implemented with required fields
- Credit system is integrated for processing costs
- API authentication and authorization patterns are established

### Data Models for HS Code Matching
[Source: architecture/data-models.md#HSCode]

**HSCode Model (External):**
```typescript
interface HSCode {
  code: string;              // HS code identifier
  description: string;        // Official HS code description  
  chapter: string;           // HS chapter classification
  section: string;           // HS section classification
  country: string;          // Country-specific variations
  confidence: number;       // AI matching confidence (0-1)
}
```

**HSCodeMatch Result:**
```typescript
interface HSCodeMatch {
  primaryMatch: HSCode;
  alternativeMatches: HSCode[];
  confidence: number;
  reasoning: string;
  processingTime: number;
}
```

### Architecture & Responsibility Division

**OpenAI Agent Responsibilities:**
- Execute semantic search queries against Vector Store via FileSearchTool
- AI-powered product description to HS code matching
- Return structured outputs with confidence scores and alternatives
- Handle OpenAI-specific error handling and retry logic

**Our Backend Service Responsibilities:**
- Provide REST API layer for frontend integration
- Business logic orchestration and workflow management
- Request/response validation with Pydantic schemas
- Performance optimization through Redis caching
- Application-level error handling and logging
- Integration with existing product processing pipeline
- Analytics and monitoring of matching operations

### Technology Stack Integration
[Source: architecture/tech-stack.md]

**Required Technologies:**
- **OpenAI Agents SDK** (Latest): Production-ready AI agent orchestration
- **FileSearchTool**: Built-in vector store integration
- **OpenAI Vector Store**: External managed vector storage (no local database)
- **FastAPI** (0.108+): Async API endpoints for HS code matching
- **Redis** (7.2+): Caching for frequently matched codes
- **Pydantic** (2.5+): Request/response validation

### File Locations
[Source: architecture/source-tree.md]

**Backend Implementation:**
- `/apps/api/src/services/hs_matching_service.py` - OpenAI Agent integration & business logic
- `/apps/api/src/services/cache_service.py` - Redis caching for performance optimization
- `/apps/api/src/api/v1/hs_matching.py` - REST API endpoints for frontend integration
- `/apps/api/src/schemas/hs_matching.py` - Pydantic validation schemas
- `/apps/api/src/core/openai_config.py` - OpenAI API & Vector Store configuration

**Note**: No local database migrations needed - HS codes stored in external OpenAI Vector Store

**Frontend Integration:**
- `/packages/shared/src/types/hs_matching.ts` - Shared TypeScript interfaces
- Integration with existing file processing components

### Performance Requirements
- HS code matching must return results in <2 seconds
- Batch processing should handle 100+ products efficiently  
- Cache hit ratio target: >70% for frequently matched descriptions
- API rate limiting to prevent abuse (aligned with OpenAI limits)
- Fallback mechanisms for OpenAI API failures

### Security and Configuration
- Secure storage of OpenAI API credentials in environment variables
- Rate limiting aligned with OpenAI API limits (5,000 RPM, 160,000 TPM)
- Input validation on all product descriptions
- Audit logging for HS code matching operations
- Error handling that doesn't expose API details to users

## Testing

### Testing Strategy
[Source: architecture/testing-strategy.md]

**Test File Locations:**
- Backend unit tests: `/apps/api/tests/unit/services/test_hs_matching.py`
- Integration tests: `/apps/api/tests/integration/test_hs_matching_integration.py`
- API tests: `/apps/api/tests/integration/api/test_hs_matching_api.py`
- Performance tests: `/apps/api/tests/performance/test_hs_matching_performance.py`

**Testing Requirements:**
- Unit tests for HSCodeMatchingService with mocked OpenAI calls
- Integration tests with OpenAI Vector Store (limited to avoid costs)
- API endpoint tests with various product descriptions
- Performance tests validating <2-second response times
- Error handling tests for OpenAI API failures
- Cache tests for Redis integration
- Load tests for batch processing capabilities

**Test Data Requirements:**
- Sample product descriptions with known HS code matches
- Edge cases (ambiguous descriptions, technical terms)
- Invalid input scenarios for error handling
- Performance test dataset (100+ product descriptions)

**Mocking Strategy:**
- Mock OpenAI Agents SDK calls in unit tests
- Use test OpenAI API key for integration tests (budget-controlled)
- Mock Redis for cache testing
- Test error scenarios with simulated API failures

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-21 | 2.0 | Complete rewrite for OpenAI Vector Store integration approach | John (PM Agent) |

## Dev Agent Record

**Agent Model Used:** claude-sonnet-4-20250514

### Debug Log References
[To be filled during development]

### Completion Notes
- **Task 1 Completed**: OpenAI Agents SDK successfully configured with structured output
- **Vector Store Integration**: Connected to vs_686e551be03481919dd944bf5d93af95 with FileSearchTool
- **Test Results**: Successful HS code matching with confidence scores 0.85-0.95
- **Performance**: First query ~16s (cold start), subsequent queries ~5-9s
- **Documentation**: Complete setup and management procedures documented

### File List
- **Modified**: `apps/api/src/core/config.py` - Added OpenAI vector store configuration
- **Created**: `apps/api/src/core/openai_config.py` - OpenAI Agents SDK configuration and models
- **Created**: `apps/api/src/core/test_openai_connection.py` - Connection testing utility
- **Created**: `apps/api/src/core/OPENAI_VECTOR_STORE_SETUP.md` - Setup and management documentation
- **Modified**: `.env.example` - Added OpenAI vector store environment variables
- **Modified**: `apps/api/src/core/__init__.py` - Fixed import issues

## QA Results
[To be filled by QA Agent]