# Story 1.2: Database Schema Design

## Status
Approved

## Story
**As a** developer,
**I want** comprehensive database schemas implemented with proper data models, relationships, and optimizations,
**so that** the application has a solid data foundation supporting all user management, file processing, AI matching, and billing features.

## Acceptance Criteria
1. Core database models (User, ProcessingJob, ProductMatch, HSCode, BillingTransaction) are implemented with all required fields
2. Database relationships and foreign key constraints are properly defined
3. PostgreSQL extensions (pgvector) are configured for AI embeddings
4. Database indexes are implemented for performance optimization
5. Alembic migration scripts are created for all schema changes
6. Database seeding scripts are updated with proper test data
7. All TypeScript interfaces match database schema exactly

## Tasks / Subtasks

- [ ] Task 1: Implement User model and schema (AC: 1, 7)
  - [ ] Create SQLAlchemy User model with all fields from data-models.md
  - [ ] Add role enum validation (USER, ADMIN, PROJECT_OWNER)
  - [ ] Add subscription tier enum validation (FREE, BASIC, PREMIUM, ENTERPRISE)
  - [ ] Implement credit balance constraints (positive_credits check)
  - [ ] Update TypeScript User interface in packages/shared/src/types/user.ts

- [ ] Task 2: Implement HSCode model with pgvector support (AC: 1, 3, 7)
  - [ ] Create SQLAlchemy HSCode model with vector embedding field
  - [ ] Configure pgvector extension in migration
  - [ ] Set embedding field as vector(1536) for OpenAI compatibility
  - [ ] Add country and is_active fields for filtering
  - [ ] Update TypeScript HSCode interface in packages/shared/src/types/processing.ts

- [ ] Task 3: Implement ProcessingJob model (AC: 1, 7)
  - [ ] Create SQLAlchemy ProcessingJob model with all status fields
  - [ ] Add status enum validation (PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED)
  - [ ] Implement file size and credits validation constraints
  - [ ] Add relationship to User model (foreign key user_id)
  - [ ] Update TypeScript ProcessingJob interface in packages/shared/src/types/processing.ts

- [ ] Task 4: Implement ProductMatch model (AC: 1, 2, 7)
  - [ ] Create SQLAlchemy ProductMatch model with product details
  - [ ] Add relationship to ProcessingJob (foreign key job_id)
  - [ ] Add relationship reference to HSCode (via matched_hs_code)
  - [ ] Implement confidence score validation (0-1 range)
  - [ ] Update TypeScript ProductMatch interface in packages/shared/src/types/processing.ts

- [ ] Task 5: Implement BillingTransaction model (AC: 1, 2, 7)
  - [ ] Create SQLAlchemy BillingTransaction model
  - [ ] Add type enum validation (CREDIT_PURCHASE, SUBSCRIPTION, REFUND)
  - [ ] Add status enum validation (PENDING, COMPLETED, FAILED, REFUNDED)
  - [ ] Add relationship to User model (foreign key user_id)
  - [ ] Update TypeScript BillingTransaction interface in packages/shared/src/types/user.ts

- [ ] Task 6: Create optimized database indexes (AC: 4)
  - [ ] Add email index on users table for authentication
  - [ ] Add compound index on users(country, subscription_tier)
  - [ ] Add HNSW vector indexes on hs_codes for similarity search
  - [ ] Add compound index on processing_jobs(user_id, created_at DESC)
  - [ ] Add status index on processing_jobs for filtering

- [ ] Task 7: Create Alembic migration scripts (AC: 5)
  - [ ] Generate migration for User table creation
  - [ ] Generate migration for HSCode table with pgvector extension
  - [ ] Generate migration for ProcessingJob table with constraints
  - [ ] Generate migration for ProductMatch table with relationships
  - [ ] Generate migration for BillingTransaction table
  - [ ] Generate migration for all database indexes

- [ ] Task 8: Update database seeding scripts (AC: 6)
  - [ ] Add sample users with different roles and subscription tiers
  - [ ] Add sample HS codes with proper embeddings for testing
  - [ ] Add sample processing jobs in various states
  - [ ] Add sample product matches with confidence scores
  - [ ] Add sample billing transactions for testing

## Dev Notes

### Previous Story Insights
Story 1.1 established the development environment with PostgreSQL and Alembic configuration. The database connection is ready and migration framework is set up.

### Data Models
[Source: architecture/data-models.md]

**User Model Requirements:**
- id: UUID primary key with gen_random_uuid()
- email: VARCHAR(255) unique, not null
- hashed_password: VARCHAR(255) not null
- role: VARCHAR(20) with CHECK constraint (USER, ADMIN, PROJECT_OWNER)
- subscription_tier: VARCHAR(20) with CHECK constraint (FREE, BASIC, PREMIUM, ENTERPRISE)
- credits_remaining: INTEGER with positive constraint, default 2
- credits_used_this_month: INTEGER not null, default 0
- company: VARCHAR(255)
- country: VARCHAR(3) not null (ISO 3166-1 alpha-3)
- created_at: TIMESTAMPTZ with NOW() default
- last_login_at: TIMESTAMPTZ nullable
- is_active: BOOLEAN not null, default TRUE

**HSCode Model Requirements:**
- code: VARCHAR(10) primary key
- description: TEXT not null
- chapter: VARCHAR(2) not null
- section: VARCHAR(2) not null
- embedding: vector(1536) for OpenAI embeddings
- country: VARCHAR(3) not null
- is_active: BOOLEAN not null, default TRUE
- updated_at: TIMESTAMPTZ not null, default NOW()

**ProcessingJob Model Requirements:**
- id: UUID primary key with gen_random_uuid()
- user_id: UUID foreign key to users(id) with CASCADE delete
- status: VARCHAR(20) with CHECK constraint (PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED)
- input_file_name: VARCHAR(255) not null
- input_file_url: TEXT not null
- input_file_size: BIGINT not null with positive constraint
- output_xml_url: TEXT nullable
- credits_used: INTEGER not null default 0 with positive constraint
- processing_time_ms: INTEGER nullable
- total_products: INTEGER default 0
- successful_matches: INTEGER default 0
- average_confidence: DECIMAL(3,2) with 0-1 constraint
- country_schema: VARCHAR(3) not null
- error_message: TEXT nullable
- created_at: TIMESTAMPTZ not null, default NOW()
- started_at: TIMESTAMPTZ nullable
- completed_at: TIMESTAMPTZ nullable

**ProductMatch Model Requirements:**
- id: UUID primary key with gen_random_uuid()
- job_id: UUID foreign key to processing_jobs(id)
- product_description: TEXT not null
- quantity: DECIMAL(10,3) not null
- unit_of_measure: VARCHAR(50) not null
- value: DECIMAL(12,2) not null
- origin_country: VARCHAR(3) not null
- matched_hs_code: VARCHAR(10) not null (references hs_codes.code)
- confidence_score: DECIMAL(3,2) not null with 0-1 constraint
- alternative_hs_codes: TEXT[] array field
- requires_manual_review: BOOLEAN not null default FALSE
- user_confirmed: BOOLEAN not null default FALSE
- created_at: TIMESTAMPTZ not null default NOW()

**BillingTransaction Model Requirements:**
- id: UUID primary key with gen_random_uuid()
- user_id: UUID foreign key to users(id)
- type: VARCHAR(20) with CHECK constraint (CREDIT_PURCHASE, SUBSCRIPTION, REFUND)
- amount: DECIMAL(10,2) not null
- currency: VARCHAR(3) not null default 'USD'
- credits_granted: INTEGER not null default 0
- payment_provider: VARCHAR(50) not null
- payment_id: VARCHAR(255) not null
- status: VARCHAR(20) with CHECK constraint (PENDING, COMPLETED, FAILED, REFUNDED)
- created_at: TIMESTAMPTZ not null default NOW()

### Database Performance Optimizations
[Source: architecture/database-schema.md]

**Required Indexes:**
- idx_users_email ON users(email) - Authentication lookups
- idx_users_country ON users(country) - Country filtering
- idx_users_subscription_tier ON users(subscription_tier) - Analytics queries
- idx_users_created_at ON users(created_at) - Temporal queries
- HNSW vector indexes on hs_codes(embedding) using vector_cosine_ops and vector_l2_ops
- idx_hs_codes_country_active ON hs_codes(country, is_active) WHERE is_active = true
- idx_processing_jobs_user_created ON processing_jobs(user_id, created_at DESC)
- idx_processing_jobs_status ON processing_jobs(status)
- idx_processing_jobs_country ON processing_jobs(country_schema)

**pgvector Extension:**
- Must enable pgvector extension for vector operations
- Configure HNSW indexes for fast similarity search on HS code embeddings
- Vector size must be 1536 to match OpenAI embedding dimensions

### File Locations for New Code
[Source: architecture/source-tree.md]

**SQLAlchemy Models:** `/apps/api/src/models/`
- user.py - User model implementation
- processing_job.py - ProcessingJob model implementation  
- hs_code.py - HSCode model with pgvector support
- __init__.py - Model imports and base configuration

**TypeScript Interfaces:** `/packages/shared/src/types/`
- user.ts - User, BillingTransaction interfaces
- processing.ts - ProcessingJob, ProductMatch, HSCode interfaces

**Alembic Migrations:** `/apps/api/alembic/versions/`
- New migration files generated by alembic revision command
- Must follow naming convention: YYYYMMDD_HHMM_NNN_description.py

**Database Seeds:** `/scripts/`
- Update seed-data.py with new model test data
- Maintain referential integrity in seed data

### Technology Stack Requirements
[Source: architecture/tech-stack.md]
- PostgreSQL 15+ with pgvector extension
- SQLAlchemy ORM with FastAPI integration
- Alembic for database migrations
- Pydantic 2.5+ for data validation
- Python 3.11+ with async support

### Coding Standards
[Source: architecture/coding-standards.md]
- Database tables: snake_case naming
- SQLAlchemy models: PascalCase class names
- TypeScript interfaces: PascalCase with exact field matching
- Environment variables: Access through config objects only
- All database transactions must use proper error handling
- Type sharing: All types defined in packages/shared

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Backend Database Tests Location:** `apps/api/tests/unit/models/`
- test_user_model.py - User model validation tests
- test_processing_job_model.py - ProcessingJob model tests
- test_hs_code_model.py - HSCode model with vector tests
- test_product_match_model.py - ProductMatch relationship tests
- test_billing_transaction_model.py - BillingTransaction tests

**Integration Tests Location:** `apps/api/tests/integration/database/`
- test_database_schema.py - Migration and constraint tests
- test_relationships.py - Foreign key and relationship tests
- test_performance.py - Index performance validation

**Test Standards:**
- Test all model validations and constraints
- Test database relationships and foreign keys
- Test pgvector functionality with sample embeddings
- Test migration scripts for up/down operations
- Use pytest fixtures for database setup/teardown
- Mock external dependencies in unit tests

### Technical Constraints
[Source: architecture/database-schema.md]
- PostgreSQL 15+ required for pgvector extension support
- Vector embedding size fixed at 1536 dimensions (OpenAI standard)
- All UUIDs generated with gen_random_uuid() for security
- TIMESTAMPTZ used for all timestamp fields
- All monetary values use DECIMAL for precision
- String length limits enforced for performance

## Testing

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Test File Locations:**
- Unit tests: `apps/api/tests/unit/models/`
- Integration tests: `apps/api/tests/integration/database/`
- Migration tests: `apps/api/tests/integration/migrations/`

**Required Test Cases:**
- Model field validation and constraints
- Database relationship integrity
- Index performance validation  
- pgvector embedding operations
- Migration up/down operations
- Seed data integrity

**Testing Frameworks:**
- pytest 7+ for all backend database tests
- SQLAlchemy test utilities for database operations
- Alembic testing utilities for migration validation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-20 | 1.0 | Initial story creation for database schema design | Scrum Master Bob |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
*This section will be populated by QA Agent during review*