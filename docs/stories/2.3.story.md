# Story 2.3: XML Generation Engine for ASYCUDA-Compliant Export

## Status
Draft

## Story
**As a** customs broker,
**I want** the system to generate ASYCUDA-compliant XML files from AI-processed product data,
**so that** I can download ready-to-submit customs declaration files for direct import into customs systems.

## Acceptance Criteria
1. Create XML Generation Service with xsdata library for XML processing and validation
2. Implement ASYCUDA XML schema support for Turkmenistan customs requirements
3. Generate country-specific XML files with proper schema validation
4. Integrate with File Processing Service workflow after AI matching completion
5. Store generated XML files in AWS S3 with secure download links
6. Support multiple product entries within single XML declaration
7. Apply proper XML formatting with UTF-8 encoding and schema validation
8. Create API endpoints for XML generation and retrieval
9. Implement error handling for schema validation failures
10. Add XML generation progress tracking with WebSocket notifications

## Tasks / Subtasks

- [x] Task 1: Create XML Generation Service (AC: 1, 3, 7)
  - [x] Create `/apps/api/src/services/xml_generation.py` service
  - [x] Implement XMLGenerationService class with xsdata integration
  - [x] Add schema validation using xsdata XSD parsing
  - [x] Create country schema configuration system
  - [x] Implement proper error handling for validation failures

- [ ] Task 2: ASYCUDA XML Schema Implementation (AC: 2, 6, 7)
  - [ ] Research and implement Turkmenistan ASYCUDA schema requirements
  - [ ] Create XML templates using Jinja2 templating engine
  - [ ] Implement multi-product XML generation within single declaration
  - [ ] Add UTF-8 encoding and proper XML formatting
  - [ ] Create schema-specific validation rules

- [ ] Task 3: File Processing Integration (AC: 4, 10)
  - [ ] Integrate XML generation into File Processing Service workflow (steps 63-68)
  - [ ] Add XML generation after AI matching completion
  - [ ] Implement progress tracking with WebSocket notifications
  - [ ] Update ProcessingJob model with XML generation status
  - [ ] Handle XML generation failures in processing pipeline

- [ ] Task 4: Storage and File Management (AC: 5)
  - [ ] Implement AWS S3 upload for generated XML files
  - [ ] Create secure download links with expiration
  - [ ] Update ProcessingJob.outputXmlUrl field
  - [ ] Add XML file cleanup and retention policies
  - [ ] Implement file size and validation checks

- [ ] Task 5: API Endpoints (AC: 8)
  - [ ] Create `/apps/api/src/api/v1/xml_generation.py` API routes
  - [ ] Implement POST /processing/{job_id}/generate-xml endpoint
  - [ ] Implement GET /processing/{job_id}/xml-download endpoint
  - [ ] Add proper authentication and authorization
  - [ ] Create error response handling for API endpoints

- [ ] Task 6: Unit Testing (AC: All)
  - [ ] Create comprehensive unit tests for XMLGenerationService
  - [ ] Test schema validation with valid and invalid data
  - [ ] Test multi-product XML generation scenarios
  - [ ] Test error handling and edge cases
  - [ ] Create API endpoint tests for XML generation routes

- [ ] Task 7: Integration Testing (AC: 4, 5, 10)
  - [ ] Test end-to-end workflow from product matching to XML generation
  - [ ] Test S3 integration and file storage
  - [ ] Test WebSocket progress notifications
  - [ ] Test ProcessingJob status updates
  - [ ] Test error recovery and rollback scenarios

## Dev Notes

### Previous Story Insights
From Story 2.2 completion:
- OpenAI Agents SDK successfully configured with FileSearchTool integration
- HS code matching achieves 0.85-0.95 confidence scores
- Comprehensive caching layer implemented with Redis
- File processing workflow established up to AI matching completion
- WebSocket progress tracking infrastructure available
- ProcessingJob model tracks processing status and statistics

### Data Models
[Source: architecture/data-models.md#ProcessingJob]

**ProcessingJob Model Requirements:**
- `outputXmlUrl: string | null` - S3 URL for generated XML file
- `countrySchema: string` - Target country for XML generation (default: "turkmenistan")
- `status` enum includes COMPLETED state after XML generation
- `processingTimeMs` tracks total time including XML generation
- `totalProducts` and `successfulMatches` inform XML structure

**ProductMatch Model Integration:**
- `matchedHSCode: string` - Primary HS code for XML export
- `productDescription: string` - Product name for XML
- `quantity: number` - Declared quantity
- `unitOfMeasure: string` - Unit type for customs
- `value: number` - Declared value
- `originCountry: string` - Country of origin
- `confidenceScore: number` - AI confidence for validation

### XML Generation Service Specifications
[Source: architecture/components.md#xml-generation-service]

**Technology Stack:**
- `xsdata` (23.8+) for XSD parsing and XML generation
- `Jinja2` for XML templating engine
- Country-specific schema files
- File storage service integration

**Key Interfaces:**
- Country schema selection API
- XSD validation and XML generation
- Template management for different countries
- Validation error reporting
- Generated file storage integration

**Dependencies:**
- File storage service (AWS S3)
- Country schema configuration
- XSD validation libraries

### API Specifications
[Source: architecture/api-specification.md#REST-API-Specification]

**Required API Endpoints:**
- `POST /api/v1/processing/{job_id}/generate-xml` - Trigger XML generation
- `GET /api/v1/processing/{job_id}/xml-download` - Download generated XML
- Authentication required for all endpoints
- Standard error response format compliance
- WebSocket integration for progress updates

### File Locations
[Source: architecture/source-tree.md#Unified-Project-Structure]

**Backend Service Files:**
- `/apps/api/src/services/xml_generation.py` - Main XML generation service
- `/apps/api/src/api/v1/xml_generation.py` - API route handlers
- `/apps/api/src/schemas/xml_generation.py` - Pydantic schemas for validation
- `/apps/api/tests/unit/test_xml_generation_service.py` - Unit tests
- `/apps/api/tests/integration/test_xml_generation_api.py` - Integration tests

**Shared Types:**
- `/packages/shared/src/types/processing.ts` - Add XML generation types
- `/packages/shared/src/types/xml.ts` - XML-specific type definitions

### Technical Constraints
[Source: architecture/tech-stack.md#AI/ML-Stack]

**Version Requirements:**
- `xsdata` (23.8+) for XSD schema parsing and XML generation
- `Jinja2` templating engine for XML template management
- Python 3.11+ for async/await patterns
- UTF-8 encoding mandatory for international compatibility

**Integration Requirements:**
- FastAPI async route handlers
- AWS S3 SDK (boto3) for file storage
- WebSocket notifications via existing infrastructure
- Redis caching for schema templates
- PostgreSQL transaction support for atomic operations

### Testing Requirements
[Source: architecture/testing-strategy.md#Backend-Tests]

**Unit Tests Location:** `/apps/api/tests/unit/`
- Test XMLGenerationService initialization and configuration
- Test schema validation with valid/invalid ProductMatch data
- Test multi-product XML generation scenarios
- Test error handling and exception cases
- Test template rendering and output formatting

**Integration Tests Location:** `/apps/api/tests/integration/`
- Test complete workflow from AI matching to XML generation
- Test S3 file upload and download functionality
- Test API endpoints with authentication
- Test WebSocket progress notification integration
- Test ProcessingJob status updates and error handling

**Testing Framework:** pytest with httpx for async FastAPI testing

### Project Structure Notes
All file paths align with monolithic FastAPI structure in `/apps/api/src/`.
XML generation service integrates with existing File Processing Service workflow at step 63-68 per core-workflows.md sequence diagram.

## Testing

### Test File Locations
- **Unit Tests:** `/apps/api/tests/unit/test_xml_generation_service.py`
- **Integration Tests:** `/apps/api/tests/integration/test_xml_generation_api.py`
- **API Tests:** `/apps/api/tests/integration/test_xml_generation_integration.py`

### Test Frameworks
- **Backend:** pytest + httpx for async FastAPI testing
- **Fixtures:** Use existing `/apps/api/tests/fixtures/` for test data

### Testing Standards
- Minimum 90% code coverage for XML generation service
- Test both successful generation and error scenarios
- Validate XML output against ASYCUDA schema requirements
- Test S3 integration with mock AWS services
- Include performance tests for large product datasets

### Specific Testing Requirements
- Test XML validation with xsdata schema parsing
- Test multi-product scenarios (1, 10, 100+ products)
- Test country schema selection and validation
- Test WebSocket progress notification accuracy
- Test atomic ProcessingJob updates and rollback on failures

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-22 | 1.0 | Initial story creation for XML Generation Engine | Bob (Scrum Master) |

## Dev Agent Record

**Agent Model Used:** Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Task 1 implementation: XML Generation Service created successfully
- All Python syntax validated with py_compile
- Jinja2 dependency added to requirements.txt

### Completion Notes
**Task 1 - COMPLETED:**
- Created comprehensive XMLGenerationService class with xsdata integration
- Implemented country schema configuration system supporting Turkmenistan
- Added robust error handling with custom exceptions (XMLGenerationError, XMLValidationError)
- Created ASYCUDA XML template for Turkmenistan using Jinja2
- Implemented comprehensive unit tests covering all service functionality
- Added Pydantic schemas for API endpoints with comprehensive validation

### File List
**Created Files:**
- `/apps/api/src/services/xml_generation.py` - Main XML generation service (423 lines)
- `/apps/api/src/templates/xml/asycuda_turkmenistan.xml.j2` - XML template for Turkmenistan
- `/apps/api/src/schemas/xml_generation.py` - Pydantic schemas for API endpoints (458 lines)
- `/apps/api/tests/unit/test_xml_generation_service.py` - Comprehensive unit tests (558 lines)

**Modified Files:**
- `/apps/api/requirements.txt` - Added jinja2 dependency

**Created Directories:**
- `/apps/api/src/templates/xml/` - XML templates directory
- `/apps/api/src/schemas/xml/` - XML schemas directory

## QA Results
[To be filled by QA Agent after implementation review]